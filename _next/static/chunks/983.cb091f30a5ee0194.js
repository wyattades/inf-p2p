"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[983],{3983:function(e,t,i){i.r(t),i.d(t,{default:function(){return ce}});var n,o=i(7568),s=i(1438),r=i(2951),a=i(4924),h=i(9815),l=i(4051),c=i.n(l),u=i(6486),d=i(5293),v=i(5294),y=i.n(v),f=i(9477),p=i(7809),m=i(4458),g=i(6042),k=i(828),w=i(9534),b=(Object.freeze(new f.FM8(0,0)),Object.freeze(new f.Pa4(0,0,0))),x=Object.freeze(new f._fP(0,0,0,1)),P=f.Pa4,C=function(){var e=(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.e(281).then(i.bind(i,7281));case 2:n=e.sent;case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Z=function(){function e(t,i){var o,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=r.bodyType,l=void 0===a?n.RigidBodyType.Dynamic:a,c=r.lockRotation,u=void 0!==c&&c,d=r.lockTranslation,v=void 0!==d&&d,y=r.angularDamping,f=void 0===y?null:y,p=r.linearDamping,m=void 0===p?null:p,g=r.mass,k=void 0===g?null:g;(0,s.Z)(this,e),this.world=i.world;var w=(o=new n.RigidBodyDesc(l)).setTranslation.apply(o,(0,h.Z)(t.position.toArray())).setRotation(t.quaternion);null!=k&&(w=w.setAdditionalMass(k)),null!=f&&f>=0&&(w=w.setAngularDamping(f)),null!=m&&m>=0&&(w=w.setLinearDamping(m)),u&&(w=w.lockRotations()),v&&(w=w.lockTranslations()),this.rigidBody=this.world.createRigidBody(w)}return(0,r.Z)(e,[{key:"addCollider",value:function(e){return this.world.createCollider(e,this.rigidBody)}},{key:"getSpeed",value:function(){return this._getSpeed||(this._getSpeed=new f.Pa4),this._getSpeed.copy(this.rigidBody.linvel()).length()}},{key:"colliders",get:function(){for(var e=[],t=0,i=this.rigidBody.numColliders();t<i;t++)e.push(this.rigidBody.collider(t));return e}},{key:"resetMovement",value:function(){this.rigidBody.setLinvel(b),this.rigidBody.setAngvel(b)}},{key:"copyToObj",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.position.copy(this.rigidBody.translation()),t||e.setRotationFromQuaternion(this.rigidBody.rotation())}},{key:"copyFromObj",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.rigidBody.setTranslation(e.position),t||this.rigidBody.setRotation(e.quaternion)}},{key:"getRotation",value:function(){return this.rigidBody.rotation()}},{key:"dispose",value:function(){this.world.removeRigidBody(this.rigidBody),this.rigidBody=null}}]),e}(),S=function(e,t){return{x:e.x+t.x,y:e.y+t.y,z:e.z+t.z}},M=(new f.Pa4,new f._fP,{red:new f.Ilk(16711680),orange:new f.Ilk(16753920),green:new f.Ilk(65280),yellow:new f.Ilk(16776960)}),L=function(){function e(){(0,s.Z)(this,e),(0,a.Z)(this,"lastError",null),(0,a.Z)(this,"debugForces",{});var t=new P(0,-78.56,0);this.world=new n.World(t)}return(0,r.Z)(e,[{key:"printPairs",value:function(e){var t,i=new Set,n=!0,o=!1,s=void 0,r=!0,a=!1,l=void 0;try{for(var c,u=Object.entries(e)[Symbol.iterator]();!(r=(c=u.next()).done);r=!0){var d=(0,k.Z)(c.value,2),v=d[0],y=d[1];try{for(var f,p=Object.keys(y)[Symbol.iterator]();!(n=(f=p.next()).done);n=!0){var m=f.value;i.add([v,m].sort().join("-"))}}catch(g){o=!0,s=g}finally{try{n||null==p.return||p.return()}finally{if(o)throw s}}}}catch(g){a=!0,l=g}finally{try{r||null==u.return||u.return()}finally{if(a)throw l}}i.size>0&&(t=console).log.apply(t,(0,h.Z)(i.keys()))}},{key:"isProximitied",value:function(e){return!1}},{key:"update",value:function(e,t){this.world.step()}},{key:"updateDebugForce",value:function(e,t,i){this._debugMesh&&(t?this.debugForces[e]=[t,S(t,i)]:delete this.debugForces[e])}},{key:"debugMesh",value:function(){var e=[],t=[],i=function(i,n,o){e.push(i,n),t.push(o,o)},n=!0,o=!1,s=void 0;try{for(var r,a=Object.values(this.debugForces)[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var h=(0,k.Z)(r.value,2),l=h[0],c=h[1];i(l,c,M.yellow)}}catch(d){o=!0,s=d}finally{try{n||null==a.return||a.return()}finally{if(o)throw s}}this.world.bodies.forEach((function(e){if(e.isDynamic()){var t=e.translation();i(t,S(t,{x:0,y:10,z:0}),M.red)}}));var u=this._debugMesh;if(!u){(u=this._debugMesh=new f.ejS(new f.u9r,new f.nls({vertexColors:!0}))).geometry.setAttribute("position",new f.TlE(new Float32Array(3e3),3)),u.geometry.setAttribute("color",new f.TlE(new Float32Array(3e3),3))}return u.geometry.attributes.position.array.fill(0),u.geometry.attributes.position.copyVector3sArray(e),u.geometry.attributes.position.needsUpdate=!0,u.geometry.attributes.color.array.fill(0),u.geometry.attributes.color.copyColorsArray(t),u.geometry.attributes.color.needsUpdate=!0,u}},{key:"dispose",value:function(){var e,t;null===(e=this.eventQueue)||void 0===e||e.free(),null===(t=this.world)||void 0===t||t.free()}}]),e}(),E=new f.xoR({vertexColors:!0,flatShading:!0,shininess:10}),_=new f.iMs(new f.Pa4(0,1e3,0),new f.Pa4(0,-1,0)),D=function(){function e(t,i,n,o){(0,s.Z)(this,e),this.game=t,this.group=i,this.x=n,this.z=o,this.mesh=null}return(0,r.Z)(e,[{key:"quaternion",get:function(){return x}},{key:"position",get:function(){return new f.Pa4((this.x+.5)*e.SIZE,0,(this.z+.5)*e.SIZE)}},{key:"getHeightAt",value:function(e,t){if(!this.mesh)return 0;_.ray.origin.set(e,1e3,t);var i=_.intersectObject(this.mesh);return i&&i.length?i[0].point.y:0}},{key:"enablePhysics",value:function(){var t=this.game.physics;return t.world?this.body?console.warn("Chunk#enablePhysics: body already exists"):this.heightsArray?(this.body=new Z(this,t,{bodyType:n.RigidBodyType.Static}),void this.body.addCollider(n.ColliderDesc.heightfield(127,127,this.heightsArray,{x:e.SIZE,y:1,z:e.SIZE}).setFriction(1))):console.warn("Chunk#enablePhysics: terrain data not loaded yet"):console.warn("Chunk#enablePhysics: Physics not loaded yet")}},{key:"setTerrain",value:function(t){var i=t.heightsArray,n=(t.indexAttr,(0,w.Z)(t,["heightsArray","indexAttr"]));this.heightsArray=i;var o,s=new f.u9r;for(var r in n){var a=n[r];a&&s.setAttribute(r,(o=a,new f.TlE(o.array,o.itemSize,o.normalized)))}this.mesh=new f.Kj0(s,E.clone()),this.mesh.matrixAutoUpdate=!1,this.mesh.position.copy(this.position),this.mesh.castShadow=this.mesh.receiveShadow=!!this.game.options.get("shadows"),this.mesh.updateMatrix(),this.group.add(this.mesh),this.game.options.get("debug")&&(this.debugChunkBoundsMesh=new f.ejS(new f.TOt(new f.DvJ(e.SIZE,512,e.SIZE)),new f.nls({color:16777215,linewidth:1})),this.mesh.matrixAutoUpdate=!1,this.debugChunkBoundsMesh.position.copy(this.mesh.position),this.group.add(this.debugChunkBoundsMesh))}},{key:"dispose",value:function(){if(this.heightsArray=null,this.mesh){for(var e in this.group.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh.geometry.attributes)this.mesh.geometry.deleteAttribute(e);this.mesh=null}if(this.debugChunkBoundsMesh){for(var t in this.group.remove(this.debugChunkBoundsMesh),this.debugChunkBoundsMesh.geometry.dispose(),this.debugChunkBoundsMesh.geometry.attributes)this.debugChunkBoundsMesh.geometry.deleteAttribute(t);this.debugChunkBoundsMesh=null}this.body&&(this.body.dispose(),this.body=null)}}]),e}();(0,a.Z)(D,"SIZE",256);var z,A,B=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=t.pushNext,n=void 0===i||i;(0,s.Z)(this,e),(0,a.Z)(this,"_ee",new d.EventEmitter),(0,a.Z)(this,"_next",[]),(0,a.Z)(this,"_error",null),(0,a.Z)(this,"_complete",null),(0,a.Z)(this,"_done",0),this.pushNext=n}return(0,r.Z)(e,[{key:"_finish",value:function(e,t){return 2===this._done&&e?e(this._error):1===this._done&&t&&t(this._complete),0!==this._done&&(this._ee.removeAllListeners(),!0)}},{key:"subscribe",value:function(e,t,i){if(e){var n=!0,o=!1,s=void 0;if(this.pushNext)try{for(var r,a=this._next[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){e(r.value)}}catch(l){o=!0,s=l}finally{try{n||null==a.return||a.return()}finally{if(o)throw s}}0===this._done&&this._ee.on("next",e)}if(this._finish(t,i));else if(t||i){var h=this;this._ee.once("done",(function(){h._finish(t,i)}))}}},{key:"next",value:function(e){this._done||(this._next.push(e),this._ee.emit("next",e))}},{key:"complete",value:function(e){this._done||(this._done=1,this._complete=e,this._ee.emit("done",null,e))}},{key:"error",value:function(e){this._done||(this._done=2,this._error=e,this._ee.emit("done",e,null))}},{key:"toPromise",value:function(){var e=this;return new Promise((function(t,i){var n=e;e._finish(i,t)||e._ee.once("done",(function(){n._finish(i,t)}))}))}}]),e}(),R=[[1,0],[0,1],[-1,0],[0,-1]],T=function(){function e(t,n){var o=this;(0,s.Z)(this,e),(0,a.Z)(this,"chunks",{}),(0,a.Z)(this,"chunkCount",0),(0,a.Z)(this,"loadedCount",0),(0,a.Z)(this,"playerChunk",null),(0,a.Z)(this,"cmdIdCounter",0),this.game=t,this.scene=t.scene,this.renderDist=Math.max(1,0|n),this.initialChunkAmount=Math.pow(2*this.renderDist+1,2),this.chunkGroup=new f.ZAu,this.scene.add(this.chunkGroup),this.worker=new Worker(i.tu(new URL(i.p+i.u(218),i.b)),{name:"terrain_worker"}),this.worker.addEventListener("message",(function(e){var t=e.data;if("terrain"===t.cmd)o._receiveLoadChunk(t.x,t.z,t.attributes)}))}return(0,r.Z)(e,[{key:"workerCmd",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this;return i?new Promise((function(i,o){var s=n,r=n.cmdIdCounter++,a=function(e){var t=e.data;"worker_response"===t.cmd&&t.cmdId===r&&(s.worker.removeEventListener("message",a),null!=t.error?o(new Error(t.error)):i(t.response))};n.worker.addEventListener("message",a),n.worker.postMessage((0,g.Z)({cmd:e,cmdId:r},t||{}))})):this.worker.postMessage((0,g.Z)({cmd:e},t||{}))}},{key:"loadInitial",value:function(t,i){var n=this;return(0,o.Z)(c().mark((function o(){var s,r,a,h,l;return c().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:for(n.unloadChunks(),n.initialLoad=new B,s=e.worldPosToChunk(t,i),r=s.x,a=s.z,h=0;h<2*n.renderDist+1;h++)for(l=0;l<2*n.renderDist+1;l++)n._requestLoadChunk(r+h-n.renderDist,a+l-n.renderDist);return n.playerChunk=n.chunks["".concat(r,",").concat(a)],o.next=7,n.initialLoad.toPromise();case 7:case"end":return o.stop()}}),o)})))()}},{key:"_requestLoadChunk",value:function(e,t){var i="".concat(e,",").concat(t);i in this.chunks&&console.warn("Already requested chunk",e,t);var n=new D(this.game,this.chunkGroup,e,t);this.chunks[i]=n,this.chunkCount++;return this.workerCmd("loadChunk",{x:n.x,z:n.z,lod:1}),n}},{key:"_receiveLoadChunk",value:function(e,t,i){console.debug("receiveLoadChunk:",e,t);var n=this.chunks["".concat(e,",").concat(t)];n?(n.setTerrain(i),n.enablePhysics(),this.loadedCount++,this.loadedCount===this.initialChunkAmount&&this.initialLoad.complete()):console.warn("Received uninitialized chunk",e,t)}},{key:"updatePlayerChunk",value:function(e,t){if(e===this.playerChunk.x&&t===this.playerChunk.z)return!1;var i=e-this.playerChunk.x,n=t-this.playerChunk.z,o=Math.sign(i),s=Math.sign(n);if(i)for(var r=-this.renderDist;r<=this.renderDist;r++){var a=this.playerChunk.x+o*this.renderDist+i,h=this.playerChunk.z+r;"".concat(a,",").concat(h)in this.chunks||this._requestLoadChunk(a,h)}if(n)for(var l=-this.renderDist;l<=this.renderDist;l++){var c=this.playerChunk.x+l,u=this.playerChunk.z+s*this.renderDist+n;"".concat(c,",").concat(u)in this.chunks||this._requestLoadChunk(c,u)}if(i&&n){var d=this.playerChunk.x+o*this.renderDist+i,v=this.playerChunk.z+s*this.renderDist+n;"".concat(d,",").concat(v)in this.chunks||this._requestLoadChunk(d,v)}this.playerChunk=this.chunks["".concat(e,",").concat(t)],this.playerChunk||(this.playerChunk=this._requestLoadChunk(e,t),console.warn("Invalid playerChunk",e,t));var y=Math.max(this.renderDist+2,2*this.renderDist),f=e-y,p=t-y,m=!0,g=!1,w=void 0;try{for(var b,x=R[Symbol.iterator]();!(m=(b=x.next()).done);m=!0)for(var P=(0,k.Z)(b.value,2),C=P[0],Z=P[1],S=0;S<2*y;S++,f+=C,p+=Z){var M="".concat(f,",").concat(p);this.unloadChunk(M)}}catch(L){g=!0,w=L}finally{try{m||null==x.return||x.return()}finally{if(g)throw w}}return!0}},{key:"updatePhysicsChunks",value:function(e,t){}},{key:"unloadChunk",value:function(e){var t=this.chunks[e];t&&(t.dispose(),delete this.chunks[e],this.chunkCount--,this.loadedCount--)}},{key:"getHeightAt",value:function(e,t){return this.playerChunk?this.playerChunk.getHeightAt(e,t):-99999}},{key:"clearMapCache",value:function(){var e=this;return(0,o.Z)(c().mark((function t(){return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.workerCmd("clearCache",null,!0);case 2:case"end":return t.stop()}}),t)})))()}},{key:"unloadChunks",value:function(){for(var e in this.chunks)this.unloadChunk(e)}},{key:"dispose",value:function(){this.unloadChunks(),this.worker.terminate()}}],[{key:"worldPosToChunk",value:function(e,t){return{x:Math.floor(e/D.SIZE),z:Math.floor(t/D.SIZE)}}}]),e}(),I=i(9788),F=function(){function e(){(0,s.Z)(this,e),this.events=[]}var t=e.prototype;return t.once=function(e,t,i){for(var n=arguments.length,o=new Array(n>3?n-3:0),s=3;s<n;s++)o[s-3]=arguments[s];return this.addEvent(e,t,i,o,!0),this},t.on=function(e,t,i){for(var n=arguments.length,o=new Array(n>3?n-3:0),s=3;s<n;s++)o[s-3]=arguments[s];return this.addEvent(e,t,i,o,!1),this},t.addEvent=function(e,t,i,n){var o,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=this,a=(0,k.Z)("on"in e?["on","off"]:"addListener"in e?["addListener","removeListener"]:["addEventListener","removeEventListener"],2),l=a[0],c=a[1],u=s?function(){for(var n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return r.off(e,t,i),i.apply(void 0,(0,h.Z)(o))}:i;(o=e)[l].apply(o,[t,u].concat((0,h.Z)(n))),this.events.push({off:c,eventName:t,eventEmitter:e,cb:i,realCb:u})},t.off=function(e,t,i){return this.events=this.events.filter((function(n){if(i){if(i!==n.cb||t!==n.eventName||e!==n.eventEmitter)return!0}else if(t){if(t!==n.eventName||e!==n.eventEmitter)return!0}else if(e&&e!==n.eventEmitter)return!0;return n.eventEmitter[n.off](n.eventName,n.realCb),!1})),this},e}(),j={forward:"w",strafeLeft:"a",backward:"s",strafeRight:"d",jump:" ",sprint:"Shift",crouch:"Control",toggleMenu:"Escape",toggleInfo:"i",toggleOrbit:"t",flipCar:"f",clearCache:"p",toggleCamera:"c"},O=function(){function e(t){var i=this;for(var n in(0,s.Z)(this,e),(0,a.Z)(this,"onPointerLockChange",(function(){document.pointerLockElement||i.pauseFromPlaying()})),(0,a.Z)(this,"onVisibilityChange",(function(){"visible"!==document.visibilityState&&i.pauseFromPlaying()})),(0,a.Z)(this,"onBlur",(function(){i.pauseFromPlaying()})),(0,a.Z)(this,"onMouseLeaveBody",(function(){i.pauseFromPlaying()})),(0,a.Z)(this,"onMousedown",(function(){i.game.state===I.D.PAUSED?i.game.setState(I.D.PLAYING):i.game.state===I.D.PLAYING&&i.lockPointer()})),(0,a.Z)(this,"onMousemove",(function(e){if(i.game.state===I.D.PLAYING){var t=i.game.options.get("mouseSensitivity")/3e3,n=e.movementX,o=e.movementY;1===o&&0===n&&(o=0),i.rotation.x-=o*t,i.rotation.y-=n*t,i.rotation.x<-Math.PI/2&&(i.rotation.x=-Math.PI/2),i.rotation.x>Math.PI/2&&(i.rotation.x=Math.PI/2)}})),(0,a.Z)(this,"onKeydown",(function(e){i.allowKey(e)||e.preventDefault();var t=i.keybinds[e.which];if(t){var n=i.keystate[t];"function"===typeof n?n():i.keystate[t]=!0}})),(0,a.Z)(this,"onKeyup",(function(e){i.allowKey(e)||e.preventDefault();var t=i.keybinds[e.which];t&&("function"!==typeof i.keystate[t]&&(i.keystate[t]=!1))})),this.game=t,this.rotation=new f.FM8(0,0),this.canvas=t.canvas,this.keybinds={},this.keystate={},j)this.setKeyBind(n,j[n]);this.em=new F}return(0,r.Z)(e,[{key:"pauseFromPlaying",value:function(){this.game.state===I.D.PLAYING&&this.game.setState(I.D.PAUSED)}},{key:"bindControls",value:function(){this.em.on(this.canvas,"mousedown",this.onMousedown),this.em.on(this.canvas,"mousemove",this.onMousemove),this.em.on(window,"keydown",this.onKeydown),this.em.on(window,"keyup",this.onKeyup),this.em.on(window,"blur",this.onBlur),this.em.on(document,"blur",this.onVisibilityChange),this.em.on(document.body,"mouseleave",this.onMouseLeaveBody),(z=this.canvas).requestPointerLock||(z.requestPointerLock=this.canvas.mozRequestPointerLock),(A=document).exitPointerLock||(A.exitPointerLock=document.mozExitPointerLock),this.bindPointerLock("on",this.onPointerLockChange)}},{key:"bindPointerLock",value:function(e,t){"onpointerlockchange"in document?this.em[e](document,"pointerlockchange",t):"onmozpointerlockchange"in document&&this.em[e](document,"mozpointerlockchange",t)}},{key:"unlockPointer",value:function(){var e;document.pointerLockElement&&(null===(e=document.exitPointerLock)||void 0===e||e.call(document))}},{key:"lockPointer",value:function(){var e,t;document.pointerLockElement||(null===(t=(e=this.canvas).requestPointerLock)||void 0===t||t.call(e))}},{key:"allowKey",value:function(e){return!(!e.ctrlKey&&!e.metaKey)||!!/^F\d+$/.test(e.key)}},{key:"setKeyBind",value:function(t,i){var n;if(1===i.length)n=i.toUpperCase().charCodeAt(0);else if(!(n=e.KeyCodeMap[i]))throw new Error("setKeyBind: invalid key ".concat(i));this.keybinds[n]=t,this.keystate[t]=!1}},{key:"bindPress",value:function(e,t){e in j?this.keystate[e]=t:console.error("Invalid keybind action:",e)}},{key:"clearPresses",value:function(){for(var e in this.keystate)"function"!==typeof this.keystate[e]&&(this.keystate[e]=!1)}},{key:"unbindControls",value:function(){this.em.off()}}]),e}();(0,a.Z)(O,"KeyCodeMap",{Shift:16,Control:17,Escape:27,ArrowUp:38,ArrowDown:40,ArrowLeft:37,ArrowRight:39});var N=i(9396),K=new f.FM8(0,0),G=function(){function e(t){(0,s.Z)(this,e),(0,a.Z)(this,"_motion",new f.Pa4),(0,a.Z)(this,"_motionRotation",new f.yGw),(0,a.Z)(this,"lastJumpAt",-9999),this.game=t,this.object=new f.Tme,this.position=this.object.position,this.rotation=this.object.rotation,this.body=new Z(this.object,this.game.physics,{lockRotation:!0}),this.body.addCollider(n.ColliderDesc.capsule(Math.max(0,2),1).setFriction(1.1).setRestitution(.15))}return(0,r.Z)(e,[{key:"setPos",value:function(e,t,i){null==e&&(e=this.position.x),null==t&&(t=this.position.y),null==i&&(i=this.position.z),this.object.position.set(e,t,i),this.body.resetMovement(),this.body.copyFromObj(this.object,!0)}},{key:"velocity",get:function(){return this.body.rigidBody.linvel()}},{key:"onGround",value:function(){var e=this.game.chunkLoader.getHeightAt(this.position.x,this.position.z);return this.position.y-3-1<=e}},{key:"update",value:function(e,t){var i=this.game.controls.rotation,n=i.x,o=i.y,s=this._motion.set(0,0,0),r=this.game.controls.keystate;r.forward&&(s.z-=1),r.backward&&(s.z+=1),r.strafeLeft&&(s.x-=1),r.strafeRight&&(s.x+=1);var a=this.onGround();r.jump&&t-this.lastJumpAt>30&&a&&(this.body.rigidBody.setLinvel((0,N.Z)((0,g.Z)({},this.body.rigidBody.linvel()),{y:40}),!0),this.lastJumpAt=t),s.applyMatrix4(this._motionRotation.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0).makeRotationY(o)),s.setLength(a?6e3:1200),this.body.rigidBody.resetForces(),this.body.rigidBody.addForce(s);var h,l,c=this.body.rigidBody.linvel();this.body.rigidBody.setLinvel((h=c,l=45,K.set(h.x,h.z).clampLength(0,l),h.x=K.x,h.z=K.y,h)),this.object.rotation.set(0,0,0),this.object.rotateY(o),this.object.rotateX(n),this.body.copyToObj(this.object,!0)}},{key:"dispose",value:function(){this.body.dispose()}}]),e}(),q={chunkX:null,chunkZ:null,x:null,y:null,z:null,FPS:null,tick:null,storage:null},U=function(){function e(){(0,s.Z)(this,e),(0,a.Z)(this,"debugStats",(0,g.Z)({},q)),(0,a.Z)(this,"events",new d.EventEmitter)}return(0,r.Z)(e,[{key:"set",value:function(e,t){e in this.debugStats?(this.debugStats[e]=t,this.events.emit("update_stats",this.debugStats)):console.info("Invalid option key:",e)}},{key:"dispose",value:function(){}}]),e}(),V=i(1903),W=i(8029),Y=i(2337),H={uniforms:{luminance:{value:.9},turbidity:{value:10},rayleigh:{value:.642},mieCoefficient:{value:.005},mieDirectionalG:{value:.9},sunPosition:{value:new f.Pa4}},vertexShader:"uniform vec3 sunPosition;\nuniform float rayleigh;\nuniform float turbidity;\nuniform float mieCoefficient;\n\nvarying vec3 vWorldPosition;\nvarying vec3 vSunDirection;\nvarying float vSunfade;\nvarying vec3 vBetaR;\nvarying vec3 vBetaM;\nvarying float vSunE;\n\nconst vec3 up = vec3( 0.0, 1.0, 0.0 );\n\n// constants for atmospheric scattering\nconst float e = 2.71828182845904523536028747135266249775724709369995957;\nconst float pi = 3.141592653589793238462643383279502884197169;\n\n// wavelength of used primaries, according to preetham\nconst vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );\n// this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:\n// (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0)\n//   * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))\nconst vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );\n\n// mie stuff\n// K coefficient for the primaries\nconst float v = 4.0;\nconst vec3 K = vec3( 0.686, 0.678, 0.666 );\n// MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K\nconst vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );\n\n// earth shadow hack\n// cutoffAngle = pi / 1.95;\nconst float cutoffAngle = 1.6110731556870734;\nconst float steepness = 1.5;\nconst float EE = 1000.0;\n\nfloat sunIntensity( float zenithAngleCos ) {\n  zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );\n  return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );\n}\n\nvec3 totalMie( float T ) {\n  float c = ( 0.2 * T ) * 10E-18;\n  return 0.434 * c * MieConst;\n}\n\nvoid main() {\n\n  vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n  vWorldPosition = worldPosition.xyz;\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n  gl_Position.z = gl_Position.w; // set z to camera.far\n\n  vSunDirection = normalize( sunPosition );\n\n  vSunE = sunIntensity( dot( vSunDirection, up ) );\n\n  vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );\n\n  float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );\n\n  // extinction (absorbtion + out scattering)\n  // rayleigh coefficients\n  vBetaR = totalRayleigh * rayleighCoefficient;\n\n  // mie coefficients\n  vBetaM = totalMie( turbidity ) * mieCoefficient;\n\n}",fragmentShader:"varying vec3 vWorldPosition;\nvarying vec3 vSunDirection;\nvarying float vSunfade;\nvarying vec3 vBetaR;\nvarying vec3 vBetaM;\nvarying float vSunE;\n\nuniform float luminance;\nuniform float mieDirectionalG;\n\nconst vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );\n\n// constants for atmospheric scattering\nconst float pi = 3.141592653589793238462643383279502884197169;\n\nconst float n = 1.0003; // refractive index of air\nconst float N = 2.545E25; // number of molecules per unit volume for air at\n// 288.15K and 1013mb (sea level -45 celsius)\n\n// optical length at zenith for molecules\nconst float rayleighZenithLength = 8.4E3;\nconst float mieZenithLength = 1.25E3;\nconst vec3 up = vec3( 0.0, 1.0, 0.0 );\n// 66 arc seconds -> degrees, and the cosine of that\nconst float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;\n\n// 3.0 / ( 16.0 * pi )\nconst float THREE_OVER_SIXTEENPI = 0.05968310365946075;\n// 1.0 / ( 4.0 * pi )\nconst float ONE_OVER_FOURPI = 0.07957747154594767;\n\nfloat rayleighPhase( float cosTheta ) {\n  return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );\n}\n\nfloat hgPhase( float cosTheta, float g ) {\n  float g2 = pow( g, 2.0 );\n  float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );\n  return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );\n}\n\n// Filmic ToneMapping http://filmicgames.com/archives/75\nconst float A = 0.15;\nconst float B = 0.50;\nconst float C = 0.10;\nconst float D = 0.20;\nconst float E = 0.02;\nconst float F = 0.30;\n\nconst float whiteScale = 1.0748724675633854; // 1.0 / Uncharted2Tonemap(1000.0)\n\nvec3 Uncharted2Tonemap( vec3 x ) {\n  return ( ( x * ( A * x + C * B ) + D * E ) / ( x * ( A * x + B ) + D * F ) ) - E / F;\n}\n\n\nvoid main() {\n  // optical length\n  // cutoff angle at 90 to avoid singularity in next formula.\n  float zenithAngle = acos( max( 0.0, dot( up, normalize( vWorldPosition - cameraPos ) ) ) );\n  float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );\n  float sR = rayleighZenithLength * inverse;\n  float sM = mieZenithLength * inverse;\n\n  // combined extinction factor\n  vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );\n\n  // in scattering\n  float cosTheta = dot( normalize( vWorldPosition - cameraPos ), vSunDirection );\n\n  float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );\n  vec3 betaRTheta = vBetaR * rPhase;\n\n  float mPhase = hgPhase( cosTheta, mieDirectionalG );\n  vec3 betaMTheta = vBetaM * mPhase;\n\n  vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );\n  Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );\n\n  // nightsky\n  vec3 direction = normalize( vWorldPosition - cameraPos );\n  float theta = acos( direction.y ); // elevation --\x3e y-axis, [-pi/2, pi/2]\n  float phi = atan( direction.z, direction.x ); // azimuth --\x3e x-axis [-pi/2, pi/2]\n  vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );\n  vec3 L0 = vec3( 0.1 ) * Fex;\n\n  // composition + solar disc\n  float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );\n  L0 += ( vSunE * 19000.0 * Fex ) * sundisk;\n\n  vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );\n\n  vec3 curr = Uncharted2Tonemap( ( log2( 2.0 / pow( luminance, 4.0 ) ) ) * texColor );\n  vec3 color = curr * whiteScale;\n\n  vec3 retColor = pow( color, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );\n\n  gl_FragColor = vec4( retColor, 1.0 );\n\n}"},J=function(e){(0,W.Z)(i,e);var t=(0,Y.Z)(i);function i(){var e;(0,s.Z)(this,i);var n=new f.Aip(1,32,15),o=new f.jyz({fragmentShader:H.fragmentShader,vertexShader:H.vertexShader,uniforms:f.rDY.clone(H.uniforms),side:f._Li});return(e=t.call(this,n,o)).setSunPos(.245,.35),e.position.y=-100,e.scale.setScalar(45e4),e}return(0,r.Z)(i,[{key:"setSunPos",value:function(e,t){var i=4e5,n=this.material.uniforms.sunPosition.value,o=Math.PI*(e-.5),s=2*Math.PI*(t-.5);n.x=i*Math.cos(s),n.y=i*Math.sin(s)*Math.sin(o),n.z=i*Math.sin(s)*Math.cos(o)}}]),i}(f.Kj0),X=J,Q=.8,$=2.4+.3,ee=-.8,te=$,ie=.04,ne=function(){function e(t,i,o,r,a){(0,s.Z)(this,e),this.game=t.game,this.vehicle=t,this.index=i,this.radius=o,this.width=r,this.offset=a,this.scene=this.vehicle.scene;var h=new f.fHI(o,o,r,24,1),l=this.mesh=new f.Kj0(h,this.vehicle.wheelMaterial),c=.25*r,u=new f.Kj0(new f.DvJ(1.75*o,c,.25*o,1,1,1),this.vehicle.wheelMaterial);u.position.y+=r/2+c/2,l.add(u);var d=this.dir=Math.sign(a.x);l.rotateZ(-d*Math.PI*.5),l.position.copy(a).add(this.vehicle.chassisMesh.position),this.scene.add(l);var v=this.body=new Z(l,this.game.physics,{angularDamping:4});v.addCollider(n.ColliderDesc.cylinder(r/2,o).setDensity(.7).setFriction(3)),this.joint=this.game.physics.world.createImpulseJoint(n.JointData.revolute(a,new f.Pa4(d,0,0),new f.Pa4(-d,0,0).applyQuaternion(l.quaternion)),this.vehicle.chassisBody.rigidBody,v.rigidBody)}return(0,r.Z)(e,[{key:"applyWheelForces",value:function(e,t,i){var n=this.body,o=this.mesh,s=2===this.index||0===this.index?-1:1,r=this.localAngVel().y,a=Math.sign(r),h=0!==t&&Math.sign(t)*s===a,l=0;if(0===t||h&&Math.abs(r)>10||(l+=s*t),0!==i&&Math.abs(e)>1&&(l+=-a*i),0!==l){var c=this.vehicle._vec3a.set(0,l,0).applyQuaternion(o.quaternion);n.rigidBody.applyTorqueImpulse(c,!0),this.game.physics.updateDebugForce(n.rigidBody.handle,o.position.clone(),c)}else this.game.physics.updateDebugForce(n.rigidBody.handle,null)}},{key:"setSteeringValue",value:function(e){}},{key:"localAngVel",value:function(){return this.vehicle._vec3b.copy(this.body.rigidBody.angvel()).applyQuaternion(this.vehicle._quat.copy(this.mesh.quaternion).invert())}},{key:"copyToObj",value:function(){this.body.copyToObj(this.mesh)}},{key:"dispose",value:function(){this.scene.remove(this.mesh),this.body.dispose(),this.body=null,this.mesh=null,this.scene=null}}]),e}(),oe=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new f.Pa4(20,5,20);(0,s.Z)(this,e),(0,a.Z)(this,"material",new f.xoR({color:10048768})),(0,a.Z)(this,"wheelMaterial",new f.xoR({color:2232576})),(0,a.Z)(this,"vehicleSteering",0),(0,a.Z)(this,"wheels",[]),(0,a.Z)(this,"_vec3a",new f.Pa4),(0,a.Z)(this,"_vec3b",new f.Pa4),(0,a.Z)(this,"_quat",new f._fP),this.game=t,this.scene=t.scene,this.game.controls.setKeyBind("acceleration","ArrowUp"),this.game.controls.setKeyBind("braking","ArrowDown"),this.game.controls.setKeyBind("turnLeft","ArrowLeft"),this.game.controls.setKeyBind("turnRight","ArrowRight"),this.createVehicle(i)}return(0,r.Z)(e,[{key:"matrixWorld",get:function(){return this.chassisMesh.matrixWorld}},{key:"setPos",value:function(e,t,i){null==e&&(e=this.position.x),null==t&&(t=this.position.y),null==i&&(i=this.position.z),this.chassisMesh.position.set(e,t,i),this.chassisMesh.quaternion.copy(x);for(var n=0;n<4;n++)this.wheels[n].body.resetMovement();this.chassisBody.resetMovement(),this.chassisBody.copyFromObj(this.chassisMesh)}},{key:"flip",value:function(){this.setPos(this.position.x,this.position.y+5,this.position.z)}},{key:"createVehicle",value:function(e){var t=this,i=this.chassisMesh=new f.Kj0(new f.DvJ(4,1.5,7,1,1,1),this.material);this.position=i.position,this.rotation=i.rotation,this.position.copy(e),(this.chassisBody=new Z(i,this.game.physics)).addCollider(n.ColliderDesc.cuboid(2,.75,3.5).setDensity(.6)),this.scene.add(i);var o=function(e,i,n,o){t.wheels[e]=new ne(t,e,i,n,o)};o(0,1.4,.8,new f.Pa4(-2.6999999999999997,-.8,2.5)),o(1,1.4,.8,new f.Pa4(te,-.8,2.5)),o(2,1.4,Q,new f.Pa4(-2.6999999999999997,ee,-2)),o(3,1.4,Q,new f.Pa4($,ee,-2))}},{key:"getForwardVelocity",value:function(){return this._vec3a.copy(this.chassisBody.rigidBody.linvel()).applyQuaternion(this.chassisMesh.quaternion).z}},{key:"update",value:function(e,t){var i=this.getForwardVelocity(),n=this.game.controls.keystate,o=0,s=0;n.acceleration&&(i<-.5?s=20:o=50),n.braking&&(i>.5?s=20:o=-50),n.turnLeft?this.vehicleSteering<.6&&(this.vehicleSteering+=ie):n.turnRight?this.vehicleSteering>-.6&&(this.vehicleSteering-=ie):this.vehicleSteering<-.04?this.vehicleSteering+=ie:this.vehicleSteering>ie?this.vehicleSteering-=ie:this.vehicleSteering=0,this.wheels[2].applyWheelForces(i,o,s),this.wheels[3].applyWheelForces(i,o,s),this.wheels[0].applyWheelForces(i,0,.5*s),this.wheels[1].applyWheelForces(i,0,.5*s),this.wheels[0].setSteeringValue(this.vehicleSteering),this.wheels[1].setSteeringValue(this.vehicleSteering),this.chassisBody.copyToObj(this.chassisMesh);var r=!0,a=!1,h=void 0;try{for(var l,c=this.wheels[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){l.value.copyToObj()}}catch(u){a=!0,h=u}finally{try{r||null==c.return||c.return()}finally{if(a)throw h}}}},{key:"dispose",value:function(){for(this.scene.remove(this.chassisMesh),this.chassisBody.dispose();this.wheels.length>0;)this.wheels.pop().dispose()}}]),e}(),se={x:1,y:100,z:1},re=function(e){return"number"===typeof e&&!Number.isNaN(e)},ae=function(){function e(t,i){var n=this;(0,s.Z)(this,e),(0,a.Z)(this,"savePos",(function(){return function(e){var t={x:e.x,y:e.y,z:e.z};localStorage.setItem("inf-p2p:save",JSON.stringify(t))}(n.posGet())})),this.posGet=t,this.posSet=i,this.start()}return(0,r.Z)(e,[{key:"start",value:function(){var e=function(){var e;try{e=JSON.parse(localStorage.getItem("inf-p2p:save"))}catch(o){}if(e&&"object"===typeof e){var t=e.x,i=e.y,n=e.z;if(re(t)&&re(i)&&re(n))return{x:t,y:i,z:n}}return(0,g.Z)({},se)}();this.posSet(e),this.saveInterval=window.setInterval(this.savePos,5e3),window.addEventListener("beforeunload",this.savePos)}},{key:"stop",value:function(){window.clearInterval(this.saveInterval),window.removeEventListener("beforeunload",this.savePos)}},{key:"dispose",value:function(){this.stop()}}]),e}(),he=function(){function e(t){(0,s.Z)(this,e),(0,a.Z)(this,"_motion",new f.Pa4),(0,a.Z)(this,"_velocity",new f.Pa4),(0,a.Z)(this,"_motionRotation",new f.yGw),this.game=t,this.object=t.camera}return(0,r.Z)(e,[{key:"update",value:function(e){var t=this.game.controls.rotation,i=t.x,n=t.y,o=this._motion.set(0,0,0),s=this.game.controls.keystate;s.forward&&(o.z-=1),s.backward&&(o.z+=1),s.strafeLeft&&(o.x-=1),s.strafeRight&&(o.x+=1),o.applyMatrix4(this._motionRotation.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0).makeRotationY(n));var r=20*e;s.sprint&&(r*=2),o.setLength(r),s.jump&&(o.y+=r),s.crouch&&(o.y-=r),this.object.position.add(o),this.object.rotation.set(0,0,0),this.object.rotateY(n),this.object.rotateX(i)}},{key:"dispose",value:function(){}}]),e}(),le=(0,u.memoize)((function(){var e,t;return!!(null===(e=window.navigator)||void 0===e||null===(t=e.storage)||void 0===t?void 0:t.estimate)})),ce=function(){function e(t){var i=this;(0,s.Z)(this,e),(0,a.Z)(this,"initialized",!1),(0,a.Z)(this,"events",new d.EventEmitter),(0,a.Z)(this,"state",null),(0,a.Z)(this,"scene",void 0),(0,a.Z)(this,"physics",void 0),(0,a.Z)(this,"render",(function(){i.effectComposer.render()})),(0,a.Z)(this,"resize",(function(){var e=window.innerWidth,t=window.innerHeight;i.camera.aspect=e/t,i.camera.updateProjectionMatrix(),i.renderer.setSize(e,t),i.render()})),(0,a.Z)(this,"followType",null),(0,a.Z)(this,"enemyUpdate",(function(e){i.enemy&&(e?(i.enemy.position.copy(e.position),i.enemy.position.y-=3,i.enemy.rotation.z=e.rotation.y+Math.PI):console.warn("Bad data"))})),(0,a.Z)(this,"relativeCameraOffset",new f.Pa4(0,7,-10)),(0,a.Z)(this,"updateEnd",(function(e,t){if(i.ui.set("FPS",Math.round(e)),t){var n=y().resetFrameDelta();console.warn("Skipped frames:",n)}})),this.canvas=t}return(0,r.Z)(e,[{key:"preload",value:function(){return(0,o.Z)(c().mark((function e(){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,C();case 2:case"end":return e.stop()}}),e)})))()}},{key:"init",value:function(){var e=this;if(this.state=null,this.options=new V.E,this.ui=new U,this.camera=new f.cPb(45,window.innerWidth/window.innerHeight,.5,2e3),this.createScene(),this.createRenderer(),this.physics=new L,this.chunkLoader=new T(this,this.options.get("renderDist")),this.controls=new O(this),this.player=new G(this),this.vehicle=new oe(this),this.createLights(),this.saver=new ae((function(){return e.player.position}),(function(t){return e.player.setPos(t.x,t.y,t.z)})),this.objectGroup=new f.ZAu,this.scene.add(this.objectGroup),this.options.get("debug")){var t=this;this.scene.add(this.physics.debugMesh()),window.GAME=this,window.cheat={setPos:function(e,i,n){t.player.setPos(e,i,n),t.loadTerrain().catch(console.error)},setTime:function(e){return t.setTime(e)}}}this.tick=0,this.setTime(8),window.addEventListener("resize",this.resize),this.mainLoop=y().setSimulationTimestep(16.666666666666668).setUpdate((function(t){try{e.update(1/t)}catch(i){console.error("update error",i),e.setState(I.D.ERROR)}})).setDraw(this.render).setEnd(this.updateEnd)}},{key:"createFog",value:function(){this.scene.fog=this.options.get("fog")?new f.yo9(14874367,.007/this.options.get("renderDist")):null}},{key:"createScene",value:function(){this.scene=new f.xsS,this.createFog(),this.sky=new X,this.scene.add(this.sky)}},{key:"createRenderer",value:function(){var e,t;null===(e=this.renderer)||void 0===e||e.dispose(),null===(t=this.effectComposer)||void 0===t||t.reset(),this.renderer=new f.CP7({antialias:!!this.options.get("antialias"),canvas:this.canvas}),this.options.get("shadows")&&(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=f._MY),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(window.innerWidth,window.innerHeight),this.effectComposer=new p.xC(this.renderer),this.effectComposer.addPass(new m.C(this.scene,this.camera))}},{key:"setup",value:function(){var e=this;return(0,o.Z)(c().mark((function t(){var i;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,(i=e.initialized)&&e.dispose(),e.initialized=!0,e.disposed=!1,e.state=null,e.setState(I.D.LOADING),t.next=9,e.preload();case 9:return t.next=11,e.init();case 11:return t.next=13,e.start();case 13:i&&e.events.emit("reinitialized"),t.next=20;break;case 16:t.prev=16,t.t0=t.catch(0),console.error("setup error:",t.t0),e.setState(I.D.ERROR);case 20:case"end":return t.stop()}}),t,null,[[0,16]])})))()}},{key:"createLights",value:function(){this.hemiLight=new f.vmT(3310847,16763007,.3),this.hemiLight.position.set(0,50,0),this.scene.add(this.hemiLight),this.dirLight=new f.Ox3(16774373,1),this.options.get("debug")&&this.scene.add(new f.Rki(this.dirLight.shadow.camera)),this.scene.add(this.dirLight)}},{key:"setTime",value:function(e){this.time=e%24;var t=e/24,i=2*-t*Math.PI-Math.PI/2;this.dirLight&&(this.dirLight.position.set(Math.cos(i),Math.sin(i),0),this.dirLight.intensity=Math.sin(i)),this.sky.setSunPos(0,t+.75),this.scene.fog&&this.scene.fog.color.setHSL(0,0,Math.max(Math.sin(Math.PI*t),.45)-.35)}},{key:"loadTerrain",value:function(){var e=this;return(0,o.Z)(c().mark((function t(){var i,n,o,s;return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=e.player.position,n=i.x,o=i.z,t.next=3,e.chunkLoader.loadInitial(n,o);case 3:s=e.chunkLoader.getHeightAt(n,o),e.player.setPos(null,s+30,null),e.ui.set("chunkX",e.chunkLoader.playerChunk.x.toString()),e.ui.set("chunkZ",e.chunkLoader.playerChunk.z.toString());case 7:case"end":return t.stop()}}),t)})))()}},{key:"start",value:function(){var e=this;return(0,o.Z)(c().mark((function t(){return c().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.loadTerrain();case 2:e.mainLoop.start(),e.controls.bindControls(),e.controls.bindPress("toggleInfo",(function(){return e.ui.toggleInfo()})),e.controls.bindPress("toggleMenu",(function(){e.state===I.D.PAUSED||e.state===I.D.PLAYING&&e.setState(I.D.PAUSED)})),e.controls.bindPress("toggleOrbit",(function(){var t;e.flyControls?(e.player.body.resetMovement(),(t=e.player).setPos.apply(t,(0,h.Z)(e.flyControls.object.position.toArray())),e.flyControls.dispose(),e.flyControls=null):e.flyControls=new he(e)})),e.controls.bindPress("toggleCamera",(function(){"vehicle"===e.followType?e.followType=null:e.followType="vehicle"})),e.controls.bindPress("flipCar",(function(){var t;null===(t=e.vehicle)||void 0===t||t.flip()})),e.setState(I.D.PLAYING);case 10:case"end":return t.stop()}}),t)})))()}},{key:"setState",value:function(e){var t,i=this.state;if(this.state=e,this.events.emit("set_game_state",e),e===I.D.PLAYING){var n;if(i===I.D.PAUSED){var o,s;null===(o=this.mainLoop)||void 0===o||o.start();var r=(null===(s=this.options)||void 0===s?void 0:s.checkChanged())||{};if(null!=r.renderDist||null!=r.debug)return void this.setup();null!=r.fog?this.createFog():null==r.antialias&&null==r.shadows||this.createRenderer()}null===(n=this.controls)||void 0===n||n.lockPointer()}else if(e===I.D.PAUSED){var a,h;null===(a=this.controls)||void 0===a||a.unlockPointer(),null===(h=this.mainLoop)||void 0===h||h.stop()}else if(e===I.D.ERROR){var l,c;null===(l=this.controls)||void 0===l||l.unlockPointer(),null===(c=this.mainLoop)||void 0===c||c.stop()}null===(t=this.controls)||void 0===t||t.clearPresses()}},{key:"cameraFollowVehicle",value:function(e){var t=this.relativeCameraOffset.clone().applyMatrix4(e.matrixWorld);t.y=e.position.y+this.relativeCameraOffset.y,this.camera.position.lerp(t,.1);var i=e.position.clone();i.y+=4,this.camera.lookAt(i)}},{key:"cameraFollowPlayer",value:function(e){this.camera.position.copy(e.position),this.camera.rotation.copy(e.object.rotation)}},{key:"update",value:function(e){var t,i;this.flyControls?this.flyControls.update(e,this.tick):null===(i=this.player)||void 0===i||i.update(e,this.tick);null===(t=this.vehicle)||void 0===t||t.update(e,this.tick);var n=!0,o=!1,s=void 0;try{for(var r,a=this.objectGroup.children[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){r.value.gameObject.update(e,this.tick)}}catch(v){o=!0,s=v}finally{try{n||null==a.return||a.return()}finally{if(o)throw s}}this.physics.update(e,this.tick);var h=null;if("vehicle"===this.followType&&this.vehicle?(this.cameraFollowVehicle(this.vehicle),h=this.vehicle.position):this.flyControls?h=this.flyControls.object.position:this.player&&(this.cameraFollowPlayer(this.player),h=this.player.position),h){this.sky.position.set(h.x,0,h.z);var l=T.worldPosToChunk(h.x,h.z),c=l.x,u=l.z;this.chunkLoader.updatePlayerChunk(c,u)&&(this.ui.set("chunkX",c.toString()),this.ui.set("chunkZ",u.toString())),this.tick%5===0&&(this.ui.set("x",h.x.toFixed(2)),this.ui.set("y",h.y.toFixed(2)),this.ui.set("z",h.z.toFixed(2)))}if(this.tick%10===0&&(this.setTime(this.time),this.ui.set("tick",this.tick.toString())),this.options.get("debug")&&this.tick%5===0&&this.physics.debugMesh(),this.tick%200===0&&le()){var d=this;navigator.storage.estimate().then((function(e){var t=e.quota,i=e.usage;d.ui.set("storage","".concat(i/t*100|0,"% (").concat(i/1e6|0,"/").concat(t/1e6|0," MB)"))}))}this.tick++,this.time+=.001}},{key:"dispose",value:function(){var e,t,i,n,o,s,r,a,h,l,c,u;if(this.disposed)return console.warn("Game already disposed!");this.disposed=!0,null===(e=this.mainLoop)||void 0===e||e.stop(),null===(t=this.player)||void 0===t||t.dispose(),null===(i=this.vehicle)||void 0===i||i.dispose(),null===(n=this.flyControls)||void 0===n||n.dispose(),null===(o=this.ui)||void 0===o||o.dispose(),null===(s=this.chunkLoader)||void 0===s||s.dispose(),null===(r=this.saver)||void 0===r||r.dispose(),null===(a=this.scene)||void 0===a||a.clear(),null===(h=this.client)||void 0===h||h.dispose(),null===(l=this.renderer)||void 0===l||l.dispose(),null===(c=this.controls)||void 0===c||c.unbindControls(),null===(u=this.physics)||void 0===u||u.dispose(),window.removeEventListener("resize",this.resize)}}]),e}()}}]);